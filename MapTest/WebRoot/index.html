<!DOCTYPE html>
<html>
	<head>
		<!-- <meta name="viewport" content="initial-scale=1.0, user-scalable=no" /> -->
		<meta charset="utf-8" />
		<title>myMap</title>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&&type=webgl&ak=pAHZZ44CiyeULjjq8hV9fMCVFhOwD3DO"></script>
		<script src="js/jquery-1.10.2.js" type="text/javascript" charset="utf-8"></script>
	<style type="text/css">
		html{height: 100%;}
		body{height: 100%;margin: 0px;padding: 0px;}
		#container{height: 100%;}
	</style>
	</head>
	<body>
		<!-- 创建地图容器 -->
		<div id="container"></div>
		<script type="text/javascript">
			$(function(){
				
			});
			// 创建地图实例 
			var map = new BMapGL.Map("container");
			// 创建点坐标 
			// var point1 = new BMapGL.Point(116.404, 39.915);
			var point1;
			//打开鼠标滚轮缩放
			map.enableScrollWheelZoom(true);
			//地图加载完成，显示学生生源地信息
			map.addEventListener('tilesloaded', function () {
			//ajax请求，取出学生信息
			    $.ajax({
					type:"post",
					url:"studentController.do",
					dataType:"json",
					success:function(response){
						if(response.code == 1){
							//console.log(response.info[0]);
							//把每个学生的信息传过去
							for(var i = 0;i<response.info.length;i++){
								//console.log(response.info[i]);
								//调用百度地图坐标转换的方法，可以将文字信息转成坐标
									getPoint(response.info[i]);
							}
						}else{
							alert("获取学生数据失败！");
						}
					}
				});
			});
			
			var myGeo = new BMapGL.Geocoder();
			/*
			  getPoint(address: String, callback: Function, city: String) 
			 对指定的地址进行解析。如果地址定位成功，则以地址所在的坐标点Point为
			 参数调用回调函数。否则，回调函数的参数为null。city为地址所在的城市名，
			 例如“北京市” 
			 */
			 myGeo.getPoint('武汉纺织大学',function(tmp){
				if (tmp) {
					//将文字解析成坐标，并设置点
					map.centerAndZoom(tmp,5);
				 var myIcon = new BMapGL.Icon("img/school.png",new BMapGL.Size(50,50));
				 var markerIcon = new BMapGL.Marker(tmp,{icon:myIcon});
				 markerIcon.setTitle('武汉纺织大学');
					// map.addOverlay(marker1);
					map.addOverlay(markerIcon);
					point1 = tmp;
				} else{
					alert('地址解析失败！');
				}
			},'武汉');
			
			//将中文地址转换成坐标
			function getPoint(info){
			//console.log(info.address);
				 myGeo.getPoint(info.address, function(point){
					if (point) {
						var tmp = new BMapGL.Point(point.lng, point.lat);
								addMarker(tmp,info);
							}
						},info.address);
			}
			var myIcon = new BMapGL.Icon("img/aerospace.png", new BMapGL.Size(32, 70), {    //小车图片
		//offset: new BMapGL.Size(0, -5),    //相当于CSS精灵
		imageOffset: new BMapGL.Size(0, 0)    //图片的偏移量。为了是图片底部中心对准坐标点。
	  });
			function addMarker(point,info){
				var markerIcon = new BMapGL.Marker(point,{icon:new BMapGL.Icon("img/circle.png",new BMapGL.Size(20,20))});
				var geoc = BMapGL.Geocoder();
				markerIcon.setTitle("姓名："+info.studentName+"\n学号："+info.empId+"\n地址："+info.address);
				map.addOverlay(markerIcon);
				var polyLine = new BMapGL.Polyline([point,point1],{
					strokeColor:"blue",//设置颜色 
					strokeWeight:3, //宽度
					 strokeOpacity:0.5//透明度
					 });
				map.addOverlay(polyLine);
				//setTimeout(function(){
					//run(point,point1);
				//},300);
			}
			//做一个小人从生源地，移动到终点的坐标
			window.run = function (point1,point2){
		var driving = new BMapGL.DrivingRoute(map);    //驾车实例
		driving.search(point1, point2);
		driving.setSearchCompleteCallback(function(){
			var pts = driving.getResults().getPlan(0).getRoute(0).getPath();    //通过驾车实例，获得一系列点的数组
			var paths = pts.length;    //获得有几个点

			var carMk = new BMapGL.Marker(pts[0],{icon:myIcon});
			map.addOverlay(carMk);
			i=0;
			function resetMkPoint(i){
				carMk.setPosition(pts[i]);
				if(i < paths){
				time = setTimeout(function(){
						i+=100;
						resetMkPoint(i);
					},100);
				}
			}
			setTimeout(function(){
				resetMkPoint(0);
			},100)

		});
	}
		</script>
	</body>
</html>
